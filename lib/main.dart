import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';

void main() {
  runApp(const MyApp());
  }

  class CardModel {
    String bank;
      String number;
        String expiry;
          String type;
            double balance;
              String? dueDate;

                CardModel({
                    required this.bank,
                        required this.number,
                            required this.expiry,
                                required this.type,
                                    required this.balance,
                                        this.dueDate,
                                          });

                                            Map<String, dynamic> toJson() => {
                                                    'bank': bank,
                                                            'number': number,
                                                                    'expiry': expiry,
                                                                            'type': type,
                                                                                    'balance': balance,
                                                                                            'dueDate': dueDate,
                                                                                                  };

                                                                                                    factory CardModel.fromJson(Map<String, dynamic> json) => CardModel(
                                                                                                            bank: json['bank'],
                                                                                                                    number: json['number'],
                                                                                                                            expiry: json['expiry'],
                                                                                                                                    type: json['type'],
                                                                                                                                            balance: json['balance'],
                                                                                                                                                    dueDate: json['dueDate'],
                                                                                                                                                          );
                                                                                                                                                          }

                                                                                                                                                          class MyApp extends StatelessWidget {
                                                                                                                                                            const MyApp({super.key});

                                                                                                                                                              @override
                                                                                                                                                                Widget build(BuildContext context) {
                                                                                                                                                                    return const MaterialApp(
                                                                                                                                                                          debugShowCheckedModeBanner: false,
                                                                                                                                                                                home: HomePage(),
                                                                                                                                                                                    );
                                                                                                                                                                                      }
                                                                                                                                                                                      }

                                                                                                                                                                                      class HomePage extends StatefulWidget {
                                                                                                                                                                                        const HomePage({super.key});

                                                                                                                                                                                          @override
                                                                                                                                                                                            State<HomePage> createState() => _HomePageState();
                                                                                                                                                                                            }

                                                                                                                                                                                            class _HomePageState extends State<HomePage> {
                                                                                                                                                                                              List<CardModel> cards = [];

                                                                                                                                                                                                @override
                                                                                                                                                                                                  void initState() {
                                                                                                                                                                                                      super.initState();
                                                                                                                                                                                                          loadCards();
                                                                                                                                                                                                            }

                                                                                                                                                                                                              Future<void> loadCards() async {
                                                                                                                                                                                                                  final prefs = await SharedPreferences.getInstance();
                                                                                                                                                                                                                      final data = prefs.getString('cards');
                                                                                                                                                                                                                          if (data != null) {
                                                                                                                                                                                                                                final decoded = jsonDecode(data) as List;
                                                                                                                                                                                                                                      setState(() {
                                                                                                                                                                                                                                              cards = decoded.map((e) => CardModel.fromJson(e)).toList();
                                                                                                                                                                                                                                                    });
                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                            Future<void> saveCards() async {
                                                                                                                                                                                                                                                                final prefs = await SharedPreferences.getInstance();
                                                                                                                                                                                                                                                                    final encoded =
                                                                                                                                                                                                                                                                            jsonEncode(cards.map((e) => e.toJson()).toList());
                                                                                                                                                                                                                                                                                await prefs.setString('cards', encoded);
                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                    void addCard() {
                                                                                                                                                                                                                                                                                        final bankController = TextEditingController();
                                                                                                                                                                                                                                                                                            final numberController = TextEditingController();
                                                                                                                                                                                                                                                                                                final expiryController = TextEditingController();
                                                                                                                                                                                                                                                                                                    final balanceController = TextEditingController();
                                                                                                                                                                                                                                                                                                        final dueDateController = TextEditingController();
                                                                                                                                                                                                                                                                                                            String type = "Debit";

                                                                                                                                                                                                                                                                                                                showDialog(
                                                                                                                                                                                                                                                                                                                      context: context,
                                                                                                                                                                                                                                                                                                                            builder: (_) => AlertDialog(
                                                                                                                                                                                                                                                                                                                                    title: const Text("Add Card"),
                                                                                                                                                                                                                                                                                                                                            content: SingleChildScrollView(
                                                                                                                                                                                                                                                                                                                                                      child: Column(
                                                                                                                                                                                                                                                                                                                                                                  children: [
                                                                                                                                                                                                                                                                                                                                                                                TextField(controller: bankController, decoration: const InputDecoration(labelText: "Bank")),
                                                                                                                                                                                                                                                                                                                                                                                              TextField(controller: numberController, decoration: const InputDecoration(labelText: "Card Number")),
                                                                                                                                                                                                                                                                                                                                                                                                            TextField(controller: expiryController, decoration: const InputDecoration(labelText: "Expiry Date")),
                                                                                                                                                                                                                                                                                                                                                                                                                          TextField(controller: balanceController, decoration: const InputDecoration(labelText: "Balance (UAH)")),
                                                                                                                                                                                                                                                                                                                                                                                                                                        DropdownButton<String>(
                                                                                                                                                                                                                                                                                                                                                                                                                                                        value: type,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        items: const [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          DropdownMenuItem(value: "Debit", child: Text("Debit")),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            DropdownMenuItem(value: "Credit", child: Text("Credit")),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            onChanged: (val) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if (val != null) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  setState(() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        type = val;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          TextField(controller: dueDateController, decoration: const InputDecoration(labelText: "Due Date (if credit)")),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                actions: [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          TextButton(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      onPressed: () {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    final newCard = CardModel(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    bank: bankController.text,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    number: numberController.text,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    expiry: expiryController.text,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    type: type,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    balance: double.tryParse(balanceController.text) ?? 0,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    dueDate: dueDateController.text.isEmpty ? null : dueDateController.text,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                setState(() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                cards.add(newCard);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            saveCards();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          Navigator.pop(context);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  child: const Text("Save"),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  double getTotalBalance() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      return cards.fold(0, (sum, card) => sum + card.balance);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          @override
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Widget build(BuildContext context) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return Scaffold(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      appBar: AppBar(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              title: const Text("Mini Finance Tracker (UAH)"),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      backgroundColor: Colors.blue,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  floatingActionButton: FloatingActionButton(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          onPressed: addCard,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  child: const Icon(Icons.add),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              body: Column(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      children: [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Padding(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            padding: const EdgeInsets.all(12),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        child: Text(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      "Total Balance: ${getTotalBalance().toStringAsFixed(2)} UAH",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    Expanded(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                child: ListView.builder(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              itemCount: cards.length,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            itemBuilder: (context, index) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            final card = cards[index];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return Card(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              margin: const EdgeInsets.all(8),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                child: ListTile(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    title: Text("${card.bank} (${card.type})"),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        subtitle: Text("**** ${card.number.substring(card.number.length - 4)}\nExpiry: ${card.expiry}"),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            trailing: Text("${card.balance.toStringAsFixed(2)} UAH"),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }